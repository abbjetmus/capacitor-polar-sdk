{"version":3,"file":"pftp-client.js","sourceRoot":"","sources":["../../src/pftp-client.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Polar File Transfer Protocol (PFTP) Client for Web Bluetooth\n * Implements RFC-76 framing and file operations\n */\n\nexport class PftpClient {\n    private mtuCharacteristic: any;\n    private d2hCharacteristic: any;\n    private sequenceNumber = 0;\n    private resetSequenceAfterWrite = true;\n    private responseBuffer: Uint8Array[] = [];\n    private responsePromise: { resolve: (value: Uint8Array) => void; reject: (error: Error) => void } | null = null;\n    private mtu = 512; // Default MTU\n\n    constructor(\n        mtuChar: any,\n        d2hChar: any,\n        _h2dChar: any\n    ) {\n        this.mtuCharacteristic = mtuChar;\n        this.d2hCharacteristic = d2hChar;\n    }\n\n    async initialize(): Promise<void> {\n        console.log('Setting up MTU notification listener...');\n        this.mtuCharacteristic.addEventListener('characteristicvaluechanged', (event: any) => {\n            console.log('ðŸ“¨ MTU characteristicvaluechanged event fired');\n            this.handleMTUNotification(event.target.value);\n        });\n\n        console.log('Starting MTU notifications...');\n        await this.mtuCharacteristic.startNotifications();\n\n        console.log('Setting up D2H notification listener...');\n        this.d2hCharacteristic.addEventListener('characteristicvaluechanged', (event: any) => {\n            console.log('ðŸ“¨ D2H characteristicvaluechanged event fired');\n            this.handleD2HNotification(event.target.value);\n        });\n\n        console.log('Starting D2H notifications...');\n        await this.d2hCharacteristic.startNotifications();\n\n        console.log('âœ… PFTP client initialized - MTU and D2H notifications active');\n    }\n\n\n    /**\n     * Send PFTP query via MTU characteristic\n     * Used for queries like SET_LOCAL_TIME, GET_LOCAL_TIME, etc.\n     */\n    async sendQuery(queryId: number, params?: Uint8Array): Promise<Uint8Array> {\n        console.log(`PFTP: Sending query ID ${queryId}`);\n\n        // RFC-60 query format: [query_id_low][query_id_high|0x80][params...]\n        const header = new Uint8Array([\n            queryId & 0xFF,\n            ((queryId >> 8) & 0x7F) | 0x80\n        ]);\n\n        let message: Uint8Array;\n        if (params) {\n            message = new Uint8Array(header.length + params.length);\n            message.set(header, 0);\n            message.set(params, header.length);\n        } else {\n            message = header;\n        }\n\n        console.log('PFTP: Query message:', Array.from(message).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));\n\n        const queryPromise = this.waitForResponse();\n        await this.sendRequest(message);\n        console.log('PFTP: Query sent, waiting for response...');\n        const response = await queryPromise;\n        console.log(`PFTP: Query response: ${response.length} bytes`);\n\n        return response;\n    }\n\n    /**\n     * Write a file to the device using PFTP PUT operation\n     */\n    async writeFile(path: string, data: Uint8Array, operation: Uint8Array): Promise<void> {\n        console.log(`PFTP: Writing file to ${path} (${data.length} bytes)`);\n        console.log(`PFTP: Operation packet: ${operation.length} bytes`);\n\n        console.log('PFTP: Skipping session initialization for Polar 360 (not supported)');\n        await new Promise(resolve => setTimeout(resolve, 100));\n\n        // Combine operation header and data into single message with RFC-60 framing\n        // RFC-60 format: [header_size_low][header_size_high][operation_bytes][data_bytes]\n        const headerSize = operation.length;\n        const completeMessage = new Uint8Array(2 + headerSize + data.length);\n        completeMessage[0] = headerSize & 0xFF;\n        completeMessage[1] = (headerSize >> 8) & 0x7F;\n        completeMessage.set(operation, 2);\n        completeMessage.set(data, 2 + headerSize);\n\n        console.log(`PFTP: Sending complete message (${completeMessage.length} bytes)...`);\n        console.log(`PFTP: RFC-60 header: size=${headerSize} [0x${completeMessage[0].toString(16).padStart(2, '0')} 0x${completeMessage[1].toString(16).padStart(2, '0')}]`);\n\n        const writePromise = this.waitForResponse();\n        await this.sendRequest(completeMessage);\n        console.log('PFTP: Complete message sent via MTU, waiting for response...');\n        const response = await writePromise;\n        console.log(`PFTP: Write response: ${response.length} bytes`);\n        this.checkResponse(response);\n\n        console.log('âœ… PFTP: File written successfully!');\n        console.log('PFTP: Skipping session termination for Polar 360 (not supported)');\n\n        // Reset sequence number after successful write\n        if (this.resetSequenceAfterWrite) {\n            console.log('PFTP: Resetting sequence number to 0');\n            this.sequenceNumber = 0;\n        }\n    }\n\n    /**\n     * Send PFTP request via MTU characteristic with RFC-76 framing\n     * Used for GET/PUT operations\n     */\n    private async sendRequest(data: Uint8Array): Promise<void> {\n        const maxPayload = this.mtu - 1;\n\n        if (maxPayload <= 0) {\n            throw new Error(`Invalid MTU: ${this.mtu}`);\n        }\n\n        const totalPackets = Math.ceil(data.length / maxPayload);\n\n        console.log(`PFTP MTU: Sending ${data.length} bytes in ${totalPackets} packets (MTU: ${this.mtu}, maxPayload: ${maxPayload})`);\n        console.log('PFTP: First 32 bytes:', Array.from(data.slice(0, 32)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));\n\n        for (let i = 0; i < totalPackets; i++) {\n            const start = i * maxPayload;\n            const end = Math.min(start + maxPayload, data.length);\n            const chunk = data.slice(start, end);\n            const isLast = i === totalPackets - 1;\n            const next = (i === 0) ? 0 : 1;\n            const status = isLast ? 1 : 2;\n\n            const header = (this.sequenceNumber << 4) | (status << 1) | next;\n            const packet = new Uint8Array(1 + chunk.length);\n            packet[0] = header;\n            packet.set(chunk, 1);\n\n            console.log(`PFTP MTU: Packet ${i + 1}/${totalPackets} [seq:${this.sequenceNumber}, status:${status}, next:${next}] - ${packet.length} bytes`);\n\n            await this.mtuCharacteristic.writeValue(packet);\n\n            if (this.sequenceNumber < 15) {\n                this.sequenceNumber++;\n            } else {\n                this.sequenceNumber = 0;\n            }\n\n            if (!isLast) {\n                await new Promise(resolve => setTimeout(resolve, 10));\n            }\n        }\n        console.log('PFTP: All packets sent via MTU');\n    }\n\n\n    /**\n     * Handle MTU notifications (for query/request responses)\n     * RFC-76 frame format:\n     * Byte 0: [sequence:4bits][status:2bits][next:1bit]\n     */\n    private handleMTUNotification(value: DataView): void {\n        const data = new Uint8Array(value.buffer);\n\n        console.log('ðŸ”µ PFTP MTU:', data.length, 'bytes:', Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));\n\n        this.processRFC76Response(data);\n    }\n\n    /**\n     * Handle D2H notifications (for device notifications)\n     * RFC-76 frame format:\n     * Byte 0: [sequence:4bits][status:2bits][next:1bit]\n     */\n    private handleD2HNotification(value: DataView): void {\n        const data = new Uint8Array(value.buffer);\n\n        console.log('ðŸ”µ PFTP D2H:', data.length, 'bytes:', Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));\n\n        this.processRFC76Response(data);\n    }\n\n    /**\n     * Process RFC-76 response (common for MTU and D2H)\n     * Error response: [header][error_low][error_high] (3 bytes)\n     * Data response: [header][payload...]\n     */\n    private processRFC76Response(data: Uint8Array): void {\n        if (data.length === 0) {\n            console.log('PFTP: Empty response (success)');\n            const promise = this.responsePromise;\n            this.responsePromise = null;\n            this.responseBuffer = [];\n            if (promise) {\n                promise.resolve(new Uint8Array(0));\n            }\n            return;\n        }\n\n        const header = data[0];\n        const next = header & 0x01;\n        const status = (header & 0x06) >> 1;\n        const sequence = header >> 4;\n\n        console.log(`RFC76: seq=${sequence}, status=${status}, next=${next}`);\n\n        const RFC76_STATUS_ERROR_OR_RESPONSE = 0;\n        const RFC76_STATUS_LAST = 1;\n\n        if (status === RFC76_STATUS_ERROR_OR_RESPONSE) {\n            if (data.length >= 3) {\n                const errorCode = data[1] | (data[2] << 8);\n\n                if (errorCode === 0) {\n                    console.log('âœ… PFTP: Success response (error code 0)');\n                    const promise = this.responsePromise;\n                    this.responsePromise = null;\n                    this.responseBuffer = [];\n                    if (promise) {\n                        promise.resolve(new Uint8Array(0));\n                    }\n                } else {\n                    console.error(`âŒ PFTP ERROR: code=${errorCode} (0x${errorCode.toString(16)})`);\n                    const promise = this.responsePromise;\n                    this.responsePromise = null;\n                    this.responseBuffer = [];\n                    if (promise) {\n                        promise.reject(new Error(`PFTP error code: ${errorCode}`));\n                    }\n                }\n            } else if (data.length === 1) {\n                console.log('âœ… PFTP: Success response (header only)');\n                const promise = this.responsePromise;\n                this.responsePromise = null;\n                this.responseBuffer = [];\n                if (promise) {\n                    promise.resolve(new Uint8Array(0));\n                }\n            } else {\n                console.warn('PFTP: Unexpected error response length:', data.length);\n                const promise = this.responsePromise;\n                this.responsePromise = null;\n                this.responseBuffer = [];\n                if (promise) {\n                    promise.resolve(data);\n                }\n            }\n            return;\n        }\n\n        if (data.length > 1) {\n            const payload = data.slice(1);\n            this.responseBuffer.push(payload);\n        }\n\n        if (status === RFC76_STATUS_LAST || next === 0) {\n            const totalLength = this.responseBuffer.reduce((sum, chunk) => sum + chunk.length, 0);\n            const combined = new Uint8Array(totalLength);\n            let offset = 0;\n\n            for (const chunk of this.responseBuffer) {\n                combined.set(chunk, offset);\n                offset += chunk.length;\n            }\n\n            console.log(`PFTP: Complete response: ${combined.length} bytes`);\n\n            const promise = this.responsePromise;\n            this.responsePromise = null;\n            this.responseBuffer = [];\n\n            if (promise) {\n                promise.resolve(combined);\n            } else {\n                console.warn('PFTP: Response received but no promise waiting');\n            }\n        }\n    }\n\n    /**\n     * Wait for response from device\n     */\n    private waitForResponse(timeout = 10000): Promise<Uint8Array> {\n        return new Promise((resolve, reject) => {\n            this.responsePromise = { resolve, reject };\n\n            setTimeout(() => {\n                if (this.responsePromise) {\n                    this.responsePromise.reject(new Error('PFTP operation timeout'));\n                    this.responsePromise = null;\n                    this.responseBuffer = [];\n                }\n            }, timeout);\n        });\n    }\n\n    /**\n     * Check PFTP response for errors\n     */\n    private checkResponse(response: Uint8Array): void {\n        if (response.length === 0) {\n            return; // Empty response = success\n        }\n\n        // Short responses like 0x02 0x07 are errors\n        if (response.length === 2) {\n            const errorType = response[0];\n            const errorCode = response[1];\n            console.error(`PFTP error: type=${errorType}, code=${errorCode}`);\n            throw new Error(`PFTP error: type=${errorType}, code=${errorCode}`);\n        }\n\n        // Check for longer error response\n        if (response.length >= 4) {\n            const view = new DataView(response.buffer);\n            const errorCode = view.getUint32(0, true);\n\n            if (errorCode !== 0) {\n                throw new Error(`PFTP error code: ${errorCode}`);\n            }\n        }\n    }\n\n    /**\n     * Clean up resources\n     */\n    async cleanup(): Promise<void> {\n        try {\n            await this.d2hCharacteristic.stopNotifications();\n        } catch (error) {\n            console.warn('Failed to stop PFTP notifications:', error);\n        }\n    }\n}\n\n"]}